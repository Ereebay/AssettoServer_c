@page "/compare"
@namespace ACDyno.Components.Pages
@inject CarLibraryService CarLibrary
@inject BalanceSuggester BalanceSuggester
@implements IDisposable

<PageTitle>ACDyno - Compare Cars</PageTitle>

<div class="dyno-main-header">
    <h1 class="dyno-main-title">Compare Cars</h1>
    <p class="dyno-main-subtitle">Side-by-side comparison with race outcome predictions</p>
</div>

<div class="dyno-card" style="margin-bottom: var(--space-lg);">
    <div class="dyno-card-header">
        <div class="dyno-card-icon">‚öîÔ∏è</div>
        <h2 class="dyno-card-title">Select Cars to Compare</h2>
    </div>
    
    @if (!CarLibrary.AvailableCars.Any())
    {
        <div class="validation-item severity-warning">
            <span class="validation-icon">‚ö†Ô∏è</span>
            <div class="validation-content">
                <div class="validation-message">No car library loaded</div>
                <div class="validation-detail">Go to the <a href="/analyze">Analyze</a> page first to scan your cars folder.</div>
            </div>
        </div>
    }
    else
    {
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: var(--space-lg); align-items: end;">
            <div>
                <label class="form-label" style="color: var(--text-secondary); margin-bottom: var(--space-xs); display: block;">
                    Car 1 @(CarLibrary.CurrentCar != null ? "(from Analyze)" : "")
                </label>
                <select class="form-dyno" style="width: 100%;" @bind="Car1FolderName">
                    <option value="">-- Select car 1 --</option>
                    @foreach (var car in CarLibrary.AvailableCars)
                    {
                        <option value="@car.FolderName">@car.DisplayName</option>
                    }
                </select>
            </div>
            
            <div style="font-size: 2rem; color: var(--dyno-primary); padding-bottom: 0.5rem; font-weight: bold;">VS</div>
            
            <div>
                <label class="form-label" style="color: var(--text-secondary); margin-bottom: var(--space-xs); display: block;">
                    Car 2
                </label>
                <select class="form-dyno" style="width: 100%;" @bind="Car2FolderName">
                    <option value="">-- Select car 2 --</option>
                    @foreach (var car in CarLibrary.AvailableCars)
                    {
                        <option value="@car.FolderName">@car.DisplayName</option>
                    }
                </select>
            </div>
        </div>
        
        <div style="margin-top: var(--space-lg); text-align: center;">
            <button class="btn-dyno btn-dyno-primary" @onclick="CompareCars" disabled="@(IsLoading || string.IsNullOrEmpty(Car1FolderName) || string.IsNullOrEmpty(Car2FolderName))">
                @if (IsLoading)
                {
                    <span class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></span>
                }
                else
                {
                    <span>‚öñÔ∏è</span>
                }
                Compare Cars
            </button>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="validation-item severity-error" style="margin-top: var(--space-md);">
            <span class="validation-icon">‚ùå</span>
            <div class="validation-content">
                <div class="validation-message">@ErrorMessage</div>
            </div>
        </div>
    }
</div>

@if (Comparison != null)
{
    <!-- Car Headers with PI -->
    <div class="comparison-grid" style="display: grid; grid-template-columns: 1fr auto 1fr; gap: var(--space-lg); margin-bottom: var(--space-lg);">
        <div class="pi-display">
            <span class="stat-label">@Comparison.Car1.BasicInfo.ScreenName</span>
            <span class="pi-value">@Comparison.Car1.Metrics.PerformanceIndex</span>
            <span class="pi-class class-@Comparison.Car1.Metrics.PerformanceClass.ToString().ToLower()">
                @Comparison.Car1.Metrics.PerformanceClass
            </span>
            <div style="margin-top: var(--space-sm); color: var(--text-secondary); font-size: 0.9rem;">
                @Comparison.Car1.Drivetrain.DriveLayout ‚Ä¢ @Comparison.Car1.Metrics.CurbWeightKg.ToString("F0") kg
            </div>
        </div>
        
        <div class="comparison-vs" style="display: flex; align-items: center; justify-content: center;">
            <div style="background: var(--bg-elevated); border-radius: 50%; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: var(--dyno-primary);">
                VS
            </div>
        </div>
        
        <div class="pi-display">
            <span class="stat-label">@Comparison.Car2.BasicInfo.ScreenName</span>
            <span class="pi-value">@Comparison.Car2.Metrics.PerformanceIndex</span>
            <span class="pi-class class-@Comparison.Car2.Metrics.PerformanceClass.ToString().ToLower()">
                @Comparison.Car2.Metrics.PerformanceClass
            </span>
            <div style="margin-top: var(--space-sm); color: var(--text-secondary); font-size: 0.9rem;">
                @Comparison.Car2.Drivetrain.DriveLayout ‚Ä¢ @Comparison.Car2.Metrics.CurbWeightKg.ToString("F0") kg
            </div>
        </div>
    </div>
    
    <!-- Category Comparisons -->
    <div class="dyno-card" style="margin-bottom: var(--space-lg);">
        <div class="dyno-card-header">
            <div class="dyno-card-icon">üìä</div>
            <h2 class="dyno-card-title">Category Comparison</h2>
        </div>
        
        <table class="comparison-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 1px solid var(--border-primary);">
                    <th style="text-align: left; padding: var(--space-sm); color: var(--text-secondary);">Category</th>
                    <th style="text-align: right; padding: var(--space-sm); color: var(--dyno-primary);">Car 1</th>
                    <th style="text-align: center; padding: var(--space-sm); color: var(--text-secondary);">Diff</th>
                    <th style="text-align: left; padding: var(--space-sm); color: var(--dyno-secondary);">Car 2</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cat in Comparison.CategoryComparisons)
                {
                    <tr style="border-bottom: 1px solid var(--border-subtle);">
                        <td style="padding: var(--space-sm); color: var(--text-primary);">@cat.Category</td>
                        <td style="text-align: right; padding: var(--space-sm); font-family: var(--font-mono); @(cat.Advantage == "Car1" ? "color: var(--dyno-primary); font-weight: bold;" : "color: var(--text-secondary);")">
                            @cat.Car1Value
                        </td>
                        <td style="text-align: center; padding: var(--space-sm); font-family: var(--font-mono); color: var(--text-muted); font-size: 0.9rem;">
                            @(cat.Difference != 0 ? (cat.Difference > 0 ? $"+{cat.Difference:F1}" : $"{cat.Difference:F1}") : "‚Äî")
                        </td>
                        <td style="padding: var(--space-sm); font-family: var(--font-mono); @(cat.Advantage == "Car2" ? "color: var(--dyno-secondary); font-weight: bold;" : "color: var(--text-secondary);")">
                            @cat.Car2Value
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    
    <!-- Race Predictions -->
    <div class="dyno-card" style="margin-bottom: var(--space-lg);">
        <div class="dyno-card-header">
            <div class="dyno-card-icon">üèÅ</div>
            <h2 class="dyno-card-title">Race Predictions</h2>
        </div>
        
        <div style="display: grid; gap: var(--space-md);">
            @{
                var predictions = new[]
                {
                    ("üö¶ Drag Race (Standing)", Comparison.RacePrediction.Car1DragRaceWin),
                    ("üîÑ Rolling Race (40 mph)", Comparison.RacePrediction.Car1RollingRaceWin),
                    ("üîÄ Twisty Road", Comparison.RacePrediction.Car1TwistyRoadWin),
                    ("üõ£Ô∏è Highway", Comparison.RacePrediction.Car1HighwayWin),
                    ("üöó Street w/ Traffic", Comparison.RacePrediction.Car1TrafficRaceWin)
                };
            }
            
            @foreach (var (label, car1Win) in predictions)
            {
                <div class="race-prediction">
                    <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                        <span style="color: var(--text-primary);">@label</span>
                        <span style="color: var(--text-muted); font-family: var(--font-mono);">
                            @((car1Win * 100).ToString("F0"))% - @(((1 - car1Win) * 100).ToString("F0"))%
                        </span>
                    </div>
                    <div style="display: flex; height: 24px; background: var(--bg-card); border-radius: 4px; overflow: hidden;">
                        <div style="width: @(car1Win * 100)%; background: linear-gradient(90deg, var(--dyno-primary), var(--dyno-primary-muted)); display: flex; align-items: center; justify-content: flex-end; padding-right: 4px;">
                            @if (car1Win > 0.3)
                            {
                                <span style="font-size: 0.7rem; color: white; font-weight: bold;">CAR 1</span>
                            }
                        </div>
                        <div style="width: @((1 - car1Win) * 100)%; background: linear-gradient(90deg, var(--dyno-secondary-muted), var(--dyno-secondary)); display: flex; align-items: center; padding-left: 4px;">
                            @if ((1 - car1Win) > 0.3)
                            {
                                <span style="font-size: 0.7rem; color: white; font-weight: bold;">CAR 2</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Overall -->
        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: var(--bg-elevated); border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-sm);">
                <span style="font-weight: bold; color: var(--text-primary);">Overall Win Probability</span>
                <span style="font-family: var(--font-mono); color: var(--text-muted);">
                    @((Comparison.RacePrediction.Car1WinProbability * 100).ToString("F0"))% - @((Comparison.RacePrediction.Car2WinProbability * 100).ToString("F0"))%
                </span>
            </div>
            <div style="display: flex; height: 32px; background: var(--bg-card); border-radius: 6px; overflow: hidden;">
                <div style="width: @(Comparison.RacePrediction.Car1WinProbability * 100)%; background: var(--dyno-primary); display: flex; align-items: center; justify-content: center;">
                    <span style="font-weight: bold; color: white;">@Comparison.Car1.BasicInfo.ScreenName</span>
                </div>
                <div style="width: @(Comparison.RacePrediction.Car2WinProbability * 100)%; background: var(--dyno-secondary); display: flex; align-items: center; justify-content: center;">
                    <span style="font-weight: bold; color: white;">@Comparison.Car2.BasicInfo.ScreenName</span>
                </div>
            </div>
            
            <div style="margin-top: var(--space-md); padding: var(--space-sm); background: var(--bg-card); border-radius: 6px;">
                <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">@Comparison.RacePrediction.Analysis</p>
            </div>
        </div>
        
        @if (Math.Abs(Comparison.PIGDifference) > 50)
        {
            <div style="margin-top: var(--space-lg); padding: var(--space-md); background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid var(--status-warning); text-align: center;">
                <strong style="color: var(--status-warning);">‚ö†Ô∏è Unbalanced</strong>
                <p style="color: var(--text-secondary); margin: var(--space-xs) 0 0 0;">
                    Consider using the <a href="/balance">Balance Suggestions</a> tool to bring these cars closer in performance.
                </p>
            </div>
        }
    </div>
}

@code {
    private string Car1FolderName { get; set; } = "";
    private string Car2FolderName { get; set; } = "";
    private bool IsLoading { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private ComparisonResult? Comparison { get; set; }
    
    protected override void OnInitialized()
    {
        CarLibrary.OnCarsListChanged += OnCarsListChanged;
        CarLibrary.OnCurrentCarChanged += OnCurrentCarChanged;
        
        // Auto-populate Car1 if there's a current car from Analyze tab
        if (CarLibrary.CurrentCar != null)
        {
            var entry = CarLibrary.AvailableCars.FirstOrDefault(c => 
                c.DisplayName == CarLibrary.CurrentCar.BasicInfo.ScreenName);
            if (entry != null)
            {
                Car1FolderName = entry.FolderName;
            }
        }
    }
    
    private void OnCarsListChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    private void OnCurrentCarChanged()
    {
        // Update Car1 when current car changes
        if (CarLibrary.CurrentCar != null)
        {
            var entry = CarLibrary.AvailableCars.FirstOrDefault(c => 
                c.DisplayName == CarLibrary.CurrentCar.BasicInfo.ScreenName);
            if (entry != null)
            {
                Car1FolderName = entry.FolderName;
            }
        }
        InvokeAsync(StateHasChanged);
    }
    
    private async Task CompareCars()
    {
        if (string.IsNullOrEmpty(Car1FolderName) || string.IsNullOrEmpty(Car2FolderName))
        {
            ErrorMessage = "Please select both cars";
            return;
        }
        
        IsLoading = true;
        ErrorMessage = null;
        
        try
        {
            var car1 = await CarLibrary.LoadCar(Car1FolderName);
            var car2 = await CarLibrary.LoadCar(Car2FolderName);
            
            if (car1 != null && car2 != null)
            {
                Comparison = BalanceSuggester.CompareCars(car1, car2);
            }
            else
            {
                ErrorMessage = "Failed to load one or both cars";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to compare cars: {ex.Message}";
            Comparison = null;
        }
        
        IsLoading = false;
    }
    
    public void Dispose()
    {
        CarLibrary.OnCarsListChanged -= OnCarsListChanged;
        CarLibrary.OnCurrentCarChanged -= OnCurrentCarChanged;
    }
}
