<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:CarBalanceTool.ViewModels"
        x:Class="CarBalanceTool.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Car Balance Tool"
        Width="1400"
        Height="900"
        MinWidth="1100"
        MinHeight="700"
        Background="#0f172a"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>


    <Grid RowDefinitions="Auto,*,Auto">

        <!-- Header -->
        <Border Grid.Row="0" Background="#1e293b" Padding="20,16">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto">
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="CAR BALANCE TOOL" FontSize="20" FontWeight="Bold" Foreground="#f1f5f9" VerticalAlignment="Center"/>
                    <Border Background="#3b82f6" CornerRadius="4" Padding="8,2" Margin="12,0,0,0" VerticalAlignment="Center">
                        <TextBlock Text="v1.0" FontSize="11" Foreground="White"/>
                    </Border>
                </StackPanel>

                <TextBox Grid.Column="1"
                         Text="{Binding CarsFolder}"
                         Watermark="Select a folder containing car data..."
                         IsReadOnly="True"
                         Margin="24,0,12,0"
                         Background="#0f172a"
                         BorderBrush="#334155"/>

                <Button Grid.Column="2"
                        Content="Browse Folder"
                        Click="OnBrowseClick"
                        Background="#3b82f6"
                        Foreground="White"
                        Padding="16,8"
                        CornerRadius="6"
                        Margin="0,0,8,0"/>

                <Button Grid.Column="3"
                        Content="Reload"
                        Command="{Binding LoadCarsCommand}"
                        IsEnabled="{Binding HasCarsLoaded}"
                        Background="#475569"
                        Foreground="White"
                        Padding="16,8"
                        CornerRadius="6"/>

                <!-- Settings Button -->
                <ToggleButton Grid.Column="4"
                              IsChecked="{Binding ShowSettings}"
                              Background="#475569"
                              Foreground="White"
                              Padding="12,8"
                              CornerRadius="6"
                              Margin="8,0,0,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="âš™" FontSize="14" Margin="0,0,6,0"/>
                        <TextBlock Text="Settings"/>
                    </StackPanel>
                </ToggleButton>
            </Grid>
        </Border>

        <!-- Settings Panel (slides down) -->
        <Border Grid.Row="1" Background="#1e293b" Padding="20,12" VerticalAlignment="Top" ZIndex="100"
                IsVisible="{Binding ShowSettings}" Margin="16,0">
            <StackPanel>
                <TextBlock Text="SETTINGS" FontWeight="Bold" FontSize="14" Foreground="#f1f5f9" Margin="0,0,0,12"/>
                <Grid ColumnDefinitions="Auto,Auto,Auto,*" RowDefinitions="Auto">
                    <TextBlock Grid.Column="0" Text="Units:" Foreground="#94a3b8" VerticalAlignment="Center" Margin="0,0,12,0"/>
                    <RadioButton Grid.Column="1" GroupName="Units" Content="Imperial (mph, HP)"
                                 IsChecked="{Binding UseImperialUnits}"
                                 Foreground="#f1f5f9" Margin="0,0,24,0"/>
                    <RadioButton Grid.Column="2" GroupName="Units" Content="Metric (km/h, kW)"
                                 IsChecked="{Binding UseMetricUnits}"
                                 Foreground="#f1f5f9"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <TabControl Grid.Row="1" Margin="16,8" Background="Transparent">
            <TabControl.Styles>
                <Style Selector="TabItem">
                    <Setter Property="FontSize" Value="14"/>
                    <Setter Property="Padding" Value="16,10"/>
                </Style>
            </TabControl.Styles>

            <!-- ==================== ANALYZE TAB ==================== -->
            <TabItem Header="ANALYZE">
                <Grid Margin="0,12,0,0">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Car Selector -->
                    <Border Grid.Row="0" Classes="card" Margin="6,0,6,6" Padding="12">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="SELECT CAR" Classes="section-header" VerticalAlignment="Center" Margin="0,0,16,0"/>
                            <AutoCompleteBox Width="400"
                                             ItemsSource="{Binding LoadedCars}"
                                             SelectedItem="{Binding SelectedAnalyzeCar}"
                                             IsEnabled="{Binding HasCarsLoaded}"
                                             FilterMode="ContainsOrdinal"
                                             MinimumPrefixLength="0"
                                             Watermark="Click or type to search..."
                                             Background="#1e293b"
                                             x:CompileBindings="False">
                                <AutoCompleteBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" Padding="4"/>
                                    </DataTemplate>
                                </AutoCompleteBox.ItemTemplate>
                            </AutoCompleteBox>
                        </StackPanel>
                    </Border>

                    <!-- Analysis Cards -->
                    <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Disabled">
                        <Grid ColumnDefinitions="Auto,*,*,*" RowDefinitions="Auto,Auto,Auto,Auto" IsVisible="{Binding HasSelectedCar}">

                            <!-- Car Preview Image -->
                            <Border Grid.Row="0" Grid.Column="0" Grid.RowSpan="4" Classes="card"
                                    IsVisible="{Binding HasPreviewImage}" Width="420">
                                <StackPanel>
                                    <TextBlock Text="CAR PREVIEW" Classes="card-title"/>
                                    <Image Source="{Binding CarPreviewImage}"
                                           Stretch="Uniform"
                                           MaxHeight="280"
                                           Margin="0,12,0,0"/>
                                    <TextBlock Text="{Binding SelectedCar.Name}"
                                               HorizontalAlignment="Center"
                                               FontSize="14" FontWeight="SemiBold"
                                               Margin="0,8,0,0"/>
                                </StackPanel>
                            </Border>

                            <!-- Performance Score Card (Large) -->
                            <Border Grid.Row="0" Grid.Column="1" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="PERFORMANCE SCORE" Classes="card-title"/>
                                    <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                        <TextBlock Text="{Binding SelectedCarMetrics.PerformanceScore, StringFormat={}{0:F1}}"
                                                   Classes="metric-value-large"/>
                                        <TextBlock Text="pts" Classes="metric-unit" FontSize="18"/>
                                    </StackPanel>
                                    <ProgressBar Classes="metric-bar" Maximum="150"
                                                 Value="{Binding SelectedCarMetrics.PerformanceScore}"
                                                 Foreground="#3b82f6" Height="10" Margin="0,12,0,0"/>
                                </StackPanel>
                            </Border>

                            <!-- Power Card -->
                            <Border Grid.Row="0" Grid.Column="2" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="ENGINE POWER" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCar.Engine.PeakPowerHp, StringFormat={}{0:F0}}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="HP" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="PEAK POWER" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCar.Engine.PeakTorque, StringFormat={}{0:F0}}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="Nm" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="PEAK TORQUE" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                    <Border Background="#1e293b" CornerRadius="6" Padding="10" Margin="0,12,0,0" x:CompileBindings="False">
                                        <Grid ColumnDefinitions="*,*">
                                            <StackPanel Grid.Column="0" Orientation="Horizontal">
                                                <TextBlock Text="@ " Foreground="#94a3b8" FontSize="12"/>
                                                <TextBlock Text="{Binding PeakPowerRpmDisplay}" Foreground="#60a5fa" FontSize="12"/>
                                                <TextBlock Text=" RPM" Foreground="#94a3b8" FontSize="12"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                <TextBlock Text="@ " Foreground="#94a3b8" FontSize="12"/>
                                                <TextBlock Text="{Binding PeakTorqueRpmDisplay}" Foreground="#60a5fa" FontSize="12"/>
                                                <TextBlock Text=" RPM" Foreground="#94a3b8" FontSize="12"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <!-- Acceleration Card -->
                            <Border Grid.Row="0" Grid.Column="3" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="ACCELERATION" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Est0To60Display}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="s" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding AccelLabel1}" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Est0To100Display}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="s" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="{Binding AccelLabel2}" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Basic Info Card -->
                            <Border Grid.Row="1" Grid.Column="1" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="VEHICLE INFO" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" Margin="0,12,0,0">
                                        <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,16">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCar.Basic.TotalMass, StringFormat={}{0:F0}}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="kg" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="MASS" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,16">
                                            <TextBlock Text="{Binding SelectedCar.Drivetrain.Type}" Classes="metric-value"/>
                                            <TextBlock Text="DRIVETRAIN" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Row="1" Grid.Column="0">
                                            <TextBlock Text="{Binding SelectedCar.Drivetrain.GearCount}" Classes="metric-value"/>
                                            <TextBlock Text="GEARS" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Row="1" Grid.Column="1">
                                            <TextBlock Text="{Binding TurboDisplay}" Classes="metric-value" Foreground="{Binding TurboColor}"/>
                                            <TextBlock Text="TURBO" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Performance Metrics Card -->
                            <Border Grid.Row="1" Grid.Column="2" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="PERFORMANCE METRICS" Classes="card-title"/>
                                    <Grid RowDefinitions="Auto,Auto,Auto" Margin="0,12,0,0">
                                        <StackPanel Grid.Row="0" Margin="0,0,0,12">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <TextBlock Text="Power-to-Weight" Foreground="#94a3b8" FontSize="13"/>
                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                    <TextBlock Text="{Binding SelectedCarMetrics.PowerToWeight, StringFormat={}{0:F3}}" FontWeight="SemiBold"/>
                                                    <TextBlock Text=" HP/kg" Foreground="#64748b"/>
                                                </StackPanel>
                                            </Grid>
                                            <ProgressBar Classes="metric-bar" Maximum="0.6"
                                                         Value="{Binding SelectedCarMetrics.PowerToWeight}"
                                                         Foreground="#22c55e"/>
                                        </StackPanel>
                                        <StackPanel Grid.Row="1" Margin="0,0,0,12" x:CompileBindings="False">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <TextBlock Text="Top Speed (Theoretical)" Foreground="#94a3b8" FontSize="13"/>
                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                    <TextBlock Text="{Binding TopSpeedDisplay}" FontWeight="SemiBold"/>
                                                    <TextBlock Text=" " Foreground="#64748b"/>
                                                    <TextBlock Text="{Binding SpeedUnitLabel}" Foreground="#64748b"/>
                                                </StackPanel>
                                            </Grid>
                                            <ProgressBar Classes="metric-bar" Maximum="400"
                                                         Value="{Binding SelectedCarMetrics.TheoreticalTopSpeed}"
                                                         Foreground="#f59e0b"/>
                                        </StackPanel>
                                        <StackPanel Grid.Row="2">
                                            <Grid ColumnDefinitions="*,Auto">
                                                <TextBlock Text="Wheel Power" Foreground="#94a3b8" FontSize="13"/>
                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                    <TextBlock Text="{Binding SelectedCarMetrics.WheelPowerHp, StringFormat={}{0:F0}}" FontWeight="SemiBold"/>
                                                    <TextBlock Text=" HP (" Foreground="#64748b"/>
                                                    <TextBlock Text="{Binding DrivetrainEfficiencyDisplay}" Foreground="#06b6d4"/>
                                                    <TextBlock Text=")" Foreground="#64748b"/>
                                                </StackPanel>
                                            </Grid>
                                            <ProgressBar Classes="metric-bar" Maximum="800"
                                                         Value="{Binding SelectedCarMetrics.WheelPowerHp}"
                                                         Foreground="#8b5cf6"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Aero Card -->
                            <Border Grid.Row="1" Grid.Column="3" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="AERODYNAMICS" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCar.Aero.TotalDragGain, StringFormat={}{0:F2}}"
                                                           Classes="metric-value"/>
                                            </StackPanel>
                                            <TextBlock Text="TOTAL DRAG" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCar.Aero.TotalClGain, StringFormat={}{0:F2}}"
                                                           Classes="metric-value"/>
                                            </StackPanel>
                                            <TextBlock Text="DOWNFORCE" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                    <ItemsControl ItemsSource="{Binding SelectedCar.Aero.Wings}" Margin="0,12,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="#1e293b" CornerRadius="4" Padding="8,6" Margin="0,2">
                                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                                        <TextBlock Text="{Binding Name}" Foreground="#94a3b8" FontSize="12"/>
                                                        <TextBlock Grid.Column="1" Foreground="#64748b" FontSize="11" Margin="0,0,12,0">
                                                            <Run Text="CD: "/>
                                                            <Run Text="{Binding CdGain, StringFormat={}{0:F2}}" Foreground="#f59e0b"/>
                                                        </TextBlock>
                                                        <TextBlock Grid.Column="2" Foreground="#64748b" FontSize="11">
                                                            <Run Text="CL: "/>
                                                            <Run Text="{Binding ClGain, StringFormat={}{0:F2}}" Foreground="#22c55e"/>
                                                        </TextBlock>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>

                            <!-- Drivetrain Card -->
                            <Border Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="DRIVETRAIN" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,2*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,*">
                                                <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,0,12">
                                                    <TextBlock Text="{Binding SelectedCar.Drivetrain.FinalDrive, StringFormat={}{0:F3}}"
                                                               FontSize="20" FontWeight="SemiBold"/>
                                                    <TextBlock Text="FINAL DRIVE" Classes="metric-label"/>
                                                </StackPanel>
                                                <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,0,12">
                                                    <TextBlock Text="{Binding SelectedCar.Engine.Limiter}"
                                                               FontSize="20" FontWeight="SemiBold" Foreground="#ef4444"/>
                                                    <TextBlock Text="REV LIMIT" Classes="metric-label"/>
                                                </StackPanel>
                                                <StackPanel Grid.Row="1" Grid.Column="0" x:CompileBindings="False">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding ShiftUpTimeDisplay}" FontSize="20" FontWeight="SemiBold"/>
                                                        <TextBlock Text="ms" FontSize="12" Foreground="#64748b" VerticalAlignment="Bottom" Margin="4,0,0,2"/>
                                                    </StackPanel>
                                                    <TextBlock Text="SHIFT UP" Classes="metric-label"/>
                                                </StackPanel>
                                                <StackPanel Grid.Row="1" Grid.Column="1" x:CompileBindings="False">
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding ShiftDownTimeDisplay}" FontSize="20" FontWeight="SemiBold"/>
                                                        <TextBlock Text="ms" FontSize="12" Foreground="#64748b" VerticalAlignment="Bottom" Margin="4,0,0,2"/>
                                                    </StackPanel>
                                                    <TextBlock Text="SHIFT DOWN" Classes="metric-label"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="GEAR RATIOS" Classes="metric-label" Margin="0,0,0,8"/>
                                            <ItemsControl ItemsSource="{Binding GearRatioDisplay}">
                                                <ItemsControl.ItemsPanel>
                                                    <ItemsPanelTemplate>
                                                        <WrapPanel/>
                                                    </ItemsPanelTemplate>
                                                </ItemsControl.ItemsPanel>
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Background="#1e293b" CornerRadius="6" Padding="10,6" Margin="4">
                                                            <StackPanel Orientation="Horizontal">
                                                                <TextBlock Text="{Binding Gear}" Foreground="#60a5fa" FontWeight="SemiBold" Margin="0,0,6,0"/>
                                                                <TextBlock Text="{Binding Ratio, StringFormat={}{0:F2}}" Foreground="#f1f5f9"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- Braking/Grip Card -->
                            <Border Grid.Row="2" Grid.Column="3" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="BRAKING &amp; GRIP" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCarMetrics.BrakingPerKg, StringFormat={}{0:F2}}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="Nm/kg" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="BRAKE FORCE" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCarMetrics.AverageTyreGrip, StringFormat={}{0:F2}}"
                                                           Classes="metric-value"/>
                                            </StackPanel>
                                            <TextBlock Text="TYRE GRIP" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                    <ProgressBar Classes="metric-bar" Maximum="2.0"
                                                 Value="{Binding SelectedCarMetrics.AverageTyreGrip}"
                                                 Foreground="#06b6d4" Margin="0,16,0,0"/>
                                    <TextBlock Text="Average grip coefficient (DX0/DY0)" Foreground="#64748b" FontSize="11" Margin="0,4,0,0"/>
                                </StackPanel>
                            </Border>

                            <!-- Row 3: Speed Analysis -->
                            <Border Grid.Row="3" Grid.Column="1" Classes="card" x:CompileBindings="False">
                                <StackPanel>
                                    <TextBlock Text="SPEED ANALYSIS" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding GearingSpeedDisplay}" Classes="metric-value"/>
                                                <TextBlock Text="{Binding SpeedUnitLabel}" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="GEARING LIMIT" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding PowerSpeedDisplay}" Classes="metric-value"/>
                                                <TextBlock Text="{Binding SpeedUnitLabel}" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="POWER LIMIT" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                    <Border Background="#1e293b" CornerRadius="6" Padding="10" Margin="0,12,0,0">
                                        <TextBlock Text="{Binding SelectedCarMetrics.SpeedAnalysis.Analysis}"
                                                   TextWrapping="Wrap" FontSize="12" Foreground="#94a3b8"/>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <!-- Clutch Analysis -->
                            <Border Grid.Row="3" Grid.Column="2" Classes="card" x:CompileBindings="False">
                                <StackPanel>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Text="CLUTCH ANALYSIS" Classes="card-title"/>
                                        <Border Grid.Column="1" CornerRadius="4" Padding="6,2"
                                                IsVisible="{Binding SelectedCarMetrics.ClutchAnalysis.IsAdequate}">
                                            <Border.Background>
                                                <SolidColorBrush Color="#22c55e"/>
                                            </Border.Background>
                                            <TextBlock Text="OK" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                        </Border>
                                    </Grid>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <StackPanel Grid.Column="0">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCarMetrics.ClutchAnalysis.ClutchMaxTorque, StringFormat={}{0:F0}}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="Nm" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="CLUTCH CAPACITY" Classes="metric-label"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="1">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding SelectedCarMetrics.ClutchAnalysis.EnginePeakTorqueBoosted, StringFormat={}{0:F0}}"
                                                           Classes="metric-value"/>
                                                <TextBlock Text="Nm" Classes="metric-unit"/>
                                            </StackPanel>
                                            <TextBlock Text="ENGINE TORQUE" Classes="metric-label"/>
                                        </StackPanel>
                                    </Grid>
                                    <Border Background="#1e293b" CornerRadius="6" Padding="10" Margin="0,12,0,0">
                                        <TextBlock Text="{Binding SelectedCarMetrics.ClutchAnalysis.Analysis}"
                                                   TextWrapping="Wrap" FontSize="12" Foreground="#94a3b8"/>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <!-- Tyre Details -->
                            <Border Grid.Row="3" Grid.Column="3" Classes="card">
                                <StackPanel>
                                    <TextBlock Text="TYRE DETAILS" Classes="card-title"/>
                                    <Grid ColumnDefinitions="*,*" Margin="0,12,0,0">
                                        <!-- Front Tyres -->
                                        <StackPanel Grid.Column="0">
                                            <TextBlock Text="FRONT" FontSize="11" Foreground="#64748b" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                            <TextBlock FontSize="13">
                                                <Run Text="{Binding SelectedCar.Tyres.Front.Width, StringFormat={}{0:F0}}"/>
                                                <Run Text="mm" Foreground="#64748b"/>
                                            </TextBlock>
                                            <TextBlock FontSize="13" Foreground="#94a3b8">
                                                <Run Text="Radius: "/>
                                                <Run Text="{Binding SelectedCar.Tyres.Front.Radius, StringFormat={}{0:F3}}"/>
                                                <Run Text="m"/>
                                            </TextBlock>
                                            <TextBlock FontSize="13" Foreground="#94a3b8">
                                                <Run Text="DY0: "/>
                                                <Run Text="{Binding SelectedCar.Tyres.Front.DY0, StringFormat={}{0:F2}}" Foreground="#22c55e"/>
                                            </TextBlock>
                                            <TextBlock FontSize="13" Foreground="#94a3b8">
                                                <Run Text="DX0: "/>
                                                <Run Text="{Binding SelectedCar.Tyres.Front.DX0, StringFormat={}{0:F2}}" Foreground="#f59e0b"/>
                                            </TextBlock>
                                        </StackPanel>
                                        <!-- Rear Tyres -->
                                        <StackPanel Grid.Column="1">
                                            <TextBlock Text="REAR" FontSize="11" Foreground="#64748b" FontWeight="SemiBold" Margin="0,0,0,6"/>
                                            <TextBlock FontSize="13">
                                                <Run Text="{Binding SelectedCar.Tyres.Rear.Width, StringFormat={}{0:F0}}"/>
                                                <Run Text="mm" Foreground="#64748b"/>
                                            </TextBlock>
                                            <TextBlock FontSize="13" Foreground="#94a3b8">
                                                <Run Text="Radius: "/>
                                                <Run Text="{Binding SelectedCar.Tyres.Rear.Radius, StringFormat={}{0:F3}}"/>
                                                <Run Text="m"/>
                                            </TextBlock>
                                            <TextBlock FontSize="13" Foreground="#94a3b8">
                                                <Run Text="DY0: "/>
                                                <Run Text="{Binding SelectedCar.Tyres.Rear.DY0, StringFormat={}{0:F2}}" Foreground="#22c55e"/>
                                            </TextBlock>
                                            <TextBlock FontSize="13" Foreground="#94a3b8">
                                                <Run Text="DX0: "/>
                                                <Run Text="{Binding SelectedCar.Tyres.Rear.DX0, StringFormat={}{0:F2}}" Foreground="#f59e0b"/>
                                            </TextBlock>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                        </Grid>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                IsVisible="{Binding !HasSelectedCar}">
                        <TextBlock Text="Select a car to analyze" FontSize="18" Foreground="#64748b" HorizontalAlignment="Center"/>
                        <TextBlock Text="Choose a folder with car data and select a car from the dropdown above"
                                   FontSize="13" Foreground="#475569" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- ==================== COMPARE TAB ==================== -->
            <TabItem Header="COMPARE">
                <Grid RowDefinitions="Auto,*" Margin="0,12,0,0">
                    <!-- Car Selectors -->
                    <Border Grid.Row="0" Classes="card" Margin="6,0,6,6" Padding="12">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <AutoCompleteBox Width="320"
                                             ItemsSource="{Binding LoadedCars}"
                                             SelectedItem="{Binding CompareCar1}"
                                             IsEnabled="{Binding HasCarsLoaded}"
                                             FilterMode="ContainsOrdinal"
                                             MinimumPrefixLength="0"
                                             Watermark="Click or type to search..."
                                             Background="#1e293b"
                                             x:CompileBindings="False">
                                <AutoCompleteBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" Padding="4"/>
                                    </DataTemplate>
                                </AutoCompleteBox.ItemTemplate>
                            </AutoCompleteBox>

                            <Border Background="#334155" CornerRadius="20" Padding="16,6" Margin="16,0">
                                <TextBlock Text="VS" FontWeight="Bold" Foreground="#94a3b8"/>
                            </Border>

                            <AutoCompleteBox Width="320"
                                             ItemsSource="{Binding LoadedCars}"
                                             SelectedItem="{Binding CompareCar2}"
                                             IsEnabled="{Binding HasCarsLoaded}"
                                             FilterMode="ContainsOrdinal"
                                             MinimumPrefixLength="0"
                                             Watermark="Click or type to search..."
                                             Background="#1e293b"
                                             x:CompileBindings="False">
                                <AutoCompleteBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" Padding="4"/>
                                    </DataTemplate>
                                </AutoCompleteBox.ItemTemplate>
                            </AutoCompleteBox>
                        </StackPanel>
                    </Border>

                    <!-- Comparison Content -->
                    <ScrollViewer Grid.Row="1" IsVisible="{Binding HasComparison}">
                        <StackPanel Margin="6">
                            <!-- Balance Rating -->
                            <Border Classes="card" HorizontalAlignment="Center" Padding="32,20">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock Text="BALANCE RATING" Classes="card-title" HorizontalAlignment="Center"/>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,12,0,8">
                                        <TextBlock Text="{Binding ComparisonData.BalanceRating, StringFormat={}{0:F0}}"
                                                   FontSize="64" FontWeight="Bold" Foreground="{Binding BalanceRatingColor}"/>
                                        <TextBlock Text="/100" FontSize="24" Foreground="#64748b" VerticalAlignment="Bottom" Margin="4,0,0,12"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding BalanceRatingDescription}"
                                               FontSize="14" Foreground="{Binding BalanceRatingColor}" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>

                            <!-- Comparison Grid -->
                            <Grid ColumnDefinitions="*,*" Margin="0,6,0,0">
                                <!-- Car 1 Stats -->
                                <Border Grid.Column="0" Classes="card">
                                    <StackPanel>
                                        <TextBlock Text="{Binding CompareCar1.Name}" Classes="card-title" FontSize="16"/>
                                        <ItemsControl ItemsSource="{Binding Car1Stats}" Margin="0,12,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#1e293b" CornerRadius="6" Padding="12" Margin="0,4">
                                                        <Grid ColumnDefinitions="*,Auto">
                                                            <TextBlock Text="{Binding Label}" Foreground="#94a3b8"/>
                                                            <TextBlock Grid.Column="1" Text="{Binding Value}" FontWeight="SemiBold"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>

                                <!-- Car 2 Stats -->
                                <Border Grid.Column="1" Classes="card">
                                    <StackPanel>
                                        <TextBlock Text="{Binding CompareCar2.Name}" Classes="card-title" FontSize="16"/>
                                        <ItemsControl ItemsSource="{Binding Car2Stats}" Margin="0,12,0,0">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#1e293b" CornerRadius="6" Padding="12" Margin="0,4">
                                                        <Grid ColumnDefinitions="*,Auto">
                                                            <TextBlock Text="{Binding Label}" Foreground="#94a3b8"/>
                                                            <TextBlock Grid.Column="1" Text="{Binding Value}" FontWeight="SemiBold"/>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Difference Bars -->
                            <Border Classes="card" Margin="0,6,0,0">
                                <StackPanel>
                                    <TextBlock Text="COMPARISON" Classes="card-title"/>
                                    <ItemsControl ItemsSource="{Binding ComparisonBars}" Margin="0,12,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <StackPanel Margin="0,8,0,8">
                                                    <Grid ColumnDefinitions="120,*,120">
                                                        <TextBlock Text="{Binding LeftValue}" HorizontalAlignment="Right" Foreground="#94a3b8"/>
                                                        <TextBlock Grid.Column="1" Text="{Binding Label}" HorizontalAlignment="Center" FontWeight="SemiBold"/>
                                                        <TextBlock Grid.Column="2" Text="{Binding RightValue}" HorizontalAlignment="Left" Foreground="#94a3b8"/>
                                                    </Grid>
                                                    <Grid ColumnDefinitions="*,4,*" Margin="0,4,0,0">
                                                        <ProgressBar Grid.Column="0" Height="8" CornerRadius="4"
                                                                     Value="{Binding LeftPercent}" Maximum="100"
                                                                     Foreground="{Binding LeftColor}"
                                                                     Background="#1e293b"
                                                                     HorizontalAlignment="Stretch"
                                                                     FlowDirection="RightToLeft"/>
                                                        <ProgressBar Grid.Column="2" Height="8" CornerRadius="4"
                                                                     Value="{Binding RightPercent}" Maximum="100"
                                                                     Foreground="{Binding RightColor}"
                                                                     Background="#1e293b"
                                                                     HorizontalAlignment="Stretch"/>
                                                    </Grid>
                                                </StackPanel>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>

                            <!-- Suggestions -->
                            <Border Classes="card" Margin="0,6,0,0" IsVisible="{Binding HasSuggestions}">
                                <StackPanel>
                                    <TextBlock Text="BALANCE SUGGESTIONS" Classes="card-title"/>
                                    <ItemsControl ItemsSource="{Binding Suggestions}" Margin="0,8,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Classes="suggestion-card" BorderBrush="{Binding PriorityColor}" x:CompileBindings="False">
                                                    <Grid ColumnDefinitions="Auto,*">
                                                        <Border Grid.Column="0" Background="{Binding PriorityColor}" CornerRadius="4" Padding="8,4" Margin="0,0,12,0" VerticalAlignment="Top">
                                                            <TextBlock Text="{Binding PriorityText}" FontSize="11" FontWeight="SemiBold" Foreground="White"/>
                                                        </Border>
                                                        <StackPanel Grid.Column="1">
                                                            <TextBlock Text="{Binding TargetCar}" FontWeight="SemiBold"/>
                                                            <TextBlock Text="{Binding Rationale}" Foreground="#94a3b8" FontSize="13" TextWrapping="Wrap"/>
                                                            <Border Background="#0f172a" CornerRadius="4" Padding="8" Margin="0,8,0,0"
                                                                    IsVisible="{Binding ShowDetails}">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <TextBlock Text="{Binding File}" FontFamily="Consolas" FontSize="12" Foreground="#60a5fa"/>
                                                                    <TextBlock Text=" [" FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding Section}" FontFamily="Consolas" FontSize="12" Foreground="#60a5fa"/>
                                                                    <TextBlock Text="] " FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding Key}" FontFamily="Consolas" FontSize="12" Foreground="#22c55e"/>
                                                                    <TextBlock Text=": " FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding CurrentValue}" FontFamily="Consolas" FontSize="12" Foreground="#ef4444"/>
                                                                    <TextBlock Text=" â†’ " FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding SuggestedValue}" FontFamily="Consolas" FontSize="12" Foreground="#22c55e"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                IsVisible="{Binding !HasComparison}">
                        <TextBlock Text="Select two cars to compare" FontSize="18" Foreground="#64748b" HorizontalAlignment="Center"/>
                        <TextBlock Text="Choose different cars from the dropdowns above to see the comparison"
                                   FontSize="13" Foreground="#475569" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- ==================== BALANCE EDITOR TAB ==================== -->
            <TabItem Header="BALANCE EDITOR">
                <Grid RowDefinitions="Auto,*" Margin="0,12,0,0">
                    <!-- Car Selector -->
                    <Border Grid.Row="0" Classes="card" Margin="6,0,6,6" Padding="12">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="SELECT CAR TO ANALYZE" Classes="section-header" VerticalAlignment="Center" Margin="0,0,16,0"/>
                            <AutoCompleteBox Width="400"
                                             ItemsSource="{Binding LoadedCars}"
                                             SelectedItem="{Binding EditorSelectedCar}"
                                             IsEnabled="{Binding HasCarsLoaded}"
                                             FilterMode="ContainsOrdinal"
                                             MinimumPrefixLength="0"
                                             Watermark="Click or type to search..."
                                             Background="#1e293b"
                                             x:CompileBindings="False">
                                <AutoCompleteBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" Padding="4"/>
                                    </DataTemplate>
                                </AutoCompleteBox.ItemTemplate>
                            </AutoCompleteBox>
                        </StackPanel>
                    </Border>

                    <!-- Editor Content -->
                    <ScrollViewer Grid.Row="1" IsVisible="{Binding HasEditorCar}">
                        <StackPanel Margin="6">
                            <!-- Quick Stats Row -->
                            <Grid ColumnDefinitions="*,*,*,*" Margin="0,0,0,6">
                                <!-- Power Stats -->
                                <Border Grid.Column="0" Classes="card">
                                    <StackPanel>
                                        <TextBlock Text="POWER" Classes="card-title"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                            <TextBlock Text="{Binding EditorSelectedCar.Engine.PeakPowerHp, StringFormat={}{0:F0}}"
                                                       FontSize="28" FontWeight="Bold" Foreground="#f59e0b"/>
                                            <TextBlock Text=" HP" FontSize="14" Foreground="#64748b" VerticalAlignment="Bottom" Margin="0,0,0,4"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding EditorSelectedCar.Engine.PeakTorqueBoosted, StringFormat={}{0:F0} Nm (boosted)}"
                                                   FontSize="12" Foreground="#94a3b8"/>
                                    </StackPanel>
                                </Border>

                                <!-- Weight Stats -->
                                <Border Grid.Column="1" Classes="card">
                                    <StackPanel>
                                        <TextBlock Text="WEIGHT" Classes="card-title"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                            <TextBlock Text="{Binding EditorSelectedCar.Basic.TotalMass, StringFormat={}{0:F0}}"
                                                       FontSize="28" FontWeight="Bold" Foreground="#3b82f6"/>
                                            <TextBlock Text=" kg" FontSize="14" Foreground="#64748b" VerticalAlignment="Bottom" Margin="0,0,0,4"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding EditorSelectedCar.Metrics.PowerToWeight, StringFormat={}{0:F3} HP/kg}"
                                                   FontSize="12" Foreground="#94a3b8"/>
                                    </StackPanel>
                                </Border>

                                <!-- Top Speed Stats -->
                                <Border Grid.Column="2" Classes="card" x:CompileBindings="False">
                                    <StackPanel>
                                        <TextBlock Text="TOP SPEED" Classes="card-title"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                            <TextBlock Text="{Binding TopSpeedDisplay}"
                                                       FontSize="28" FontWeight="Bold" Foreground="#22c55e"/>
                                            <TextBlock Text=" " FontSize="14" Foreground="#64748b" VerticalAlignment="Bottom" Margin="0,0,0,4"/>
                                            <TextBlock Text="{Binding SpeedUnitLabel}" FontSize="14" Foreground="#64748b" VerticalAlignment="Bottom" Margin="0,0,0,4"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding EditorSelectedCar.Metrics.SpeedAnalysis.LimitingFactor, StringFormat=Limited by: {0}}"
                                                   FontSize="12" Foreground="#94a3b8"/>
                                    </StackPanel>
                                </Border>

                                <!-- Acceleration Stats -->
                                <Border Grid.Column="3" Classes="card">
                                    <StackPanel>
                                        <TextBlock Text="{Binding AccelLabel1}" Classes="card-title"/>
                                        <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
                                            <TextBlock Text="{Binding Est0To60Display}"
                                                       FontSize="28" FontWeight="Bold" Foreground="#8b5cf6"/>
                                            <TextBlock Text=" s" FontSize="14" Foreground="#64748b" VerticalAlignment="Bottom" Margin="0,0,0,4"/>
                                        </StackPanel>
                                        <TextBlock Text="{Binding EditorSelectedCar.Drivetrain.Type}"
                                                   FontSize="12" Foreground="#94a3b8"/>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Analysis Cards Row -->
                            <Grid ColumnDefinitions="*,*" Margin="0,0,0,6">
                                <!-- Speed Analysis -->
                                <Border Grid.Column="0" Classes="card">
                                    <StackPanel>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Text="SPEED ANALYSIS" Classes="card-title"/>
                                            <Border Grid.Column="1" IsVisible="{Binding HasSpeedIssue}"
                                                    Background="#ef4444" CornerRadius="4" Padding="8,2">
                                                <TextBlock Text="ISSUE" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                            </Border>
                                        </Grid>
                                        <TextBlock Text="{Binding SpeedAnalysisText}"
                                                   TextWrapping="Wrap" Margin="0,12,0,0"
                                                   FontSize="13" Foreground="#94a3b8"/>
                                        <Border Background="#1e293b" CornerRadius="6" Padding="12" Margin="0,12,0,0">
                                            <Grid ColumnDefinitions="*,*">
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Gearing Limit" FontSize="11" Foreground="#64748b"/>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding GearingSpeedDisplay}" FontSize="16" FontWeight="SemiBold"/>
                                                        <TextBlock Text=" " FontSize="14" Foreground="#64748b"/>
                                                        <TextBlock Text="{Binding SpeedUnitLabel}" FontSize="14" Foreground="#64748b"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Power Limit" FontSize="11" Foreground="#64748b"/>
                                                    <StackPanel Orientation="Horizontal">
                                                        <TextBlock Text="{Binding PowerSpeedDisplay}" FontSize="16" FontWeight="SemiBold"/>
                                                        <TextBlock Text=" " FontSize="14" Foreground="#64748b"/>
                                                        <TextBlock Text="{Binding SpeedUnitLabel}" FontSize="14" Foreground="#64748b"/>
                                                    </StackPanel>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </StackPanel>
                                </Border>

                                <!-- Clutch Analysis -->
                                <Border Grid.Column="1" Classes="card">
                                    <StackPanel>
                                        <Grid ColumnDefinitions="*,Auto">
                                            <TextBlock Text="CLUTCH ANALYSIS" Classes="card-title"/>
                                            <Border Grid.Column="1" IsVisible="{Binding HasClutchIssue}"
                                                    Background="#ef4444" CornerRadius="4" Padding="8,2">
                                                <TextBlock Text="UNDERSIZED" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                            </Border>
                                        </Grid>
                                        <TextBlock Text="{Binding ClutchAnalysisText}"
                                                   TextWrapping="Wrap" Margin="0,12,0,0"
                                                   FontSize="13" Foreground="#94a3b8"/>
                                        <Border Background="#1e293b" CornerRadius="6" Padding="12" Margin="0,12,0,0" x:CompileBindings="False">
                                            <Grid ColumnDefinitions="*,*">
                                                <StackPanel Grid.Column="0">
                                                    <TextBlock Text="Clutch Capacity" FontSize="11" Foreground="#64748b"/>
                                                    <TextBlock FontSize="16" FontWeight="SemiBold">
                                                        <Run Text="{Binding EditorSelectedCar.Metrics.ClutchAnalysis.ClutchMaxTorque, StringFormat={}{0:F0}}"/>
                                                        <Run Text=" Nm" Foreground="#64748b"/>
                                                    </TextBlock>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1">
                                                    <TextBlock Text="Engine Torque" FontSize="11" Foreground="#64748b"/>
                                                    <TextBlock FontSize="16" FontWeight="SemiBold">
                                                        <Run Text="{Binding EditorSelectedCar.Metrics.ClutchAnalysis.EnginePeakTorqueBoosted, StringFormat={}{0:F0}}"/>
                                                        <Run Text=" Nm" Foreground="#64748b"/>
                                                    </TextBlock>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </StackPanel>
                                </Border>
                            </Grid>

                            <!-- Issues List -->
                            <Border Classes="card" Margin="0,0,0,6">
                                <StackPanel>
                                    <Grid ColumnDefinitions="*,Auto">
                                        <TextBlock Text="DETECTED ISSUES" Classes="card-title"/>
                                        <Border Background="#334155" CornerRadius="12" Padding="12,4">
                                            <TextBlock Text="{Binding EditorIssues.Count, StringFormat={}{0} issues}"
                                                       FontSize="12" Foreground="#94a3b8"/>
                                        </Border>
                                    </Grid>
                                    <ItemsControl ItemsSource="{Binding EditorIssues}" Margin="0,12,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="#1e293b" CornerRadius="8" Padding="16" Margin="0,6" x:CompileBindings="False">
                                                    <Grid ColumnDefinitions="Auto,*">
                                                        <StackPanel Grid.Column="0" Width="100">
                                                            <Border Background="{Binding SeverityColor}" CornerRadius="4" Padding="8,4" HorizontalAlignment="Left">
                                                                <TextBlock Text="{Binding Severity}" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                                            </Border>
                                                            <TextBlock Text="{Binding Category}" FontSize="11" Foreground="#64748b" Margin="0,6,0,0"/>
                                                        </StackPanel>
                                                        <StackPanel Grid.Column="1" Margin="12,0,0,0">
                                                            <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="14"/>
                                                            <TextBlock Text="{Binding Description}" TextWrapping="Wrap"
                                                                       Foreground="#94a3b8" FontSize="13" Margin="0,4,0,0"/>
                                                            <Border Background="#0f172a" CornerRadius="4" Padding="10" Margin="0,8,0,0">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <TextBlock Text="FIX: " FontWeight="SemiBold" Foreground="#22c55e" FontSize="12"/>
                                                                    <TextBlock Text="{Binding Suggestion}" Foreground="#94a3b8" FontSize="12"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- No Issues Message -->
                                    <Border Background="#1e293b" CornerRadius="8" Padding="24" Margin="0,12,0,0"
                                            IsVisible="{Binding !EditorIssues.Count}">
                                        <StackPanel HorizontalAlignment="Center">
                                            <TextBlock Text="No issues detected" FontSize="16" FontWeight="SemiBold"
                                                       Foreground="#22c55e" HorizontalAlignment="Center"/>
                                            <TextBlock Text="This car appears to have realistic performance values"
                                                       FontSize="13" Foreground="#64748b" HorizontalAlignment="Center" Margin="0,4,0,0"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </Border>

                            <!-- Suggestions List (if any) -->
                            <Border Classes="card" IsVisible="{Binding EditorSuggestions.Count}">
                                <StackPanel>
                                    <TextBlock Text="RECOMMENDED CHANGES" Classes="card-title"/>
                                    <ItemsControl ItemsSource="{Binding EditorSuggestions}" Margin="0,8,0,0">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Classes="suggestion-card" BorderBrush="{Binding PriorityColor}" x:CompileBindings="False">
                                                    <Grid ColumnDefinitions="Auto,*">
                                                        <Border Grid.Column="0" Background="{Binding PriorityColor}" CornerRadius="4" Padding="8,4" Margin="0,0,12,0" VerticalAlignment="Top">
                                                            <TextBlock Text="{Binding PriorityText}" FontSize="11" FontWeight="SemiBold" Foreground="White"/>
                                                        </Border>
                                                        <StackPanel Grid.Column="1">
                                                            <TextBlock Text="{Binding TargetCar}" FontWeight="SemiBold"/>
                                                            <TextBlock Text="{Binding Rationale}" Foreground="#94a3b8" FontSize="13" TextWrapping="Wrap"/>
                                                            <Border Background="#0f172a" CornerRadius="4" Padding="8" Margin="0,8,0,0"
                                                                    IsVisible="{Binding ShowDetails}">
                                                                <StackPanel Orientation="Horizontal">
                                                                    <TextBlock Text="{Binding File}" FontFamily="Consolas" FontSize="12" Foreground="#60a5fa"/>
                                                                    <TextBlock Text=" [" FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding Section}" FontFamily="Consolas" FontSize="12" Foreground="#60a5fa"/>
                                                                    <TextBlock Text="] " FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding Key}" FontFamily="Consolas" FontSize="12" Foreground="#22c55e"/>
                                                                    <TextBlock Text=": " FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding CurrentValue}" FontFamily="Consolas" FontSize="12" Foreground="#ef4444"/>
                                                                    <TextBlock Text=" -> " FontFamily="Consolas" FontSize="12" Foreground="#64748b"/>
                                                                    <TextBlock Text="{Binding SuggestedValue}" FontFamily="Consolas" FontSize="12" Foreground="#22c55e"/>
                                                                </StackPanel>
                                                            </Border>
                                                        </StackPanel>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>

                    <!-- Empty State -->
                    <StackPanel Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center"
                                IsVisible="{Binding !HasEditorCar}">
                        <TextBlock Text="Select a car to analyze" FontSize="18" Foreground="#64748b" HorizontalAlignment="Center"/>
                        <TextBlock Text="Choose a car from the dropdown above to see detailed performance analysis and issues"
                                   FontSize="13" Foreground="#475569" HorizontalAlignment="Center" Margin="0,8,0,0"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- ==================== FLEET BALANCE TAB ==================== -->
            <TabItem Header="FLEET BALANCE">
                <Grid RowDefinitions="Auto,*,Auto" Margin="0,12,0,0">
                    <!-- Reference Selector -->
                    <Border Grid.Row="0" Classes="card" Margin="6,0,6,6" Padding="12">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="REFERENCE CAR" Classes="section-header" VerticalAlignment="Center" Margin="0,0,16,0"/>
                            <AutoCompleteBox Width="350"
                                             ItemsSource="{Binding LoadedCars}"
                                             SelectedItem="{Binding ReferenceCar}"
                                             IsEnabled="{Binding HasCarsLoaded}"
                                             FilterMode="ContainsOrdinal"
                                             MinimumPrefixLength="0"
                                             Watermark="Click or type to search..."
                                             Background="#1e293b"
                                             x:CompileBindings="False">
                                <AutoCompleteBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Name}" Padding="4"/>
                                    </DataTemplate>
                                </AutoCompleteBox.ItemTemplate>
                            </AutoCompleteBox>
                            <TextBlock Text="Leave empty to auto-select median car" Foreground="#64748b" FontSize="12"
                                       VerticalAlignment="Center" Margin="16,0,0,0"/>
                        </StackPanel>
                    </Border>

                    <!-- Fleet Grid -->
                    <Border Grid.Row="1" Classes="card" Margin="6,0">
                        <DataGrid ItemsSource="{Binding FleetEntries}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  GridLinesVisibility="Horizontal"
                                  BorderThickness="0"
                                  Background="Transparent"
                                  HeadersVisibility="Column">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Car" Binding="{Binding CarName}" Width="250"/>
                                <DataGridTextColumn Header="Balance" Binding="{Binding BalanceText}" Width="100"/>
                                <DataGridTextColumn Header="Score" Binding="{Binding ScoreDiffText}" Width="100"/>
                                <DataGridTextColumn Header="P/W" Binding="{Binding PtwDiffText}" Width="120"/>
                                <DataGridTextColumn Header="Top Speed (mph)" Binding="{Binding TopSpeedText}" Width="120"/>
                                <DataGridTextColumn Header="0-60 mph" Binding="{Binding AccelText}" Width="100"/>
                                <DataGridTextColumn Header="Issues" Binding="{Binding IssuesText}" Width="80"/>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Border>

                    <!-- Summary -->
                    <Border Grid.Row="2" Classes="card" Margin="6,6,6,0" Padding="16,12">
                        <Grid ColumnDefinitions="*,*,*">
                            <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding FleetAverageBalance, StringFormat={}{0:F0}}"
                                           FontSize="32" FontWeight="Bold" Foreground="#3b82f6" HorizontalAlignment="Center"/>
                                <TextBlock Text="AVG BALANCE" Classes="metric-label" HorizontalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding FleetTotalIssues}"
                                           FontSize="32" FontWeight="Bold" Foreground="#f59e0b" HorizontalAlignment="Center"/>
                                <TextBlock Text="TOTAL ISSUES" Classes="metric-label" HorizontalAlignment="Center"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding LoadedCars.Count}"
                                           FontSize="32" FontWeight="Bold" Foreground="#22c55e" HorizontalAlignment="Center"/>
                                <TextBlock Text="CARS LOADED" Classes="metric-label" HorizontalAlignment="Center"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="#1e293b" Padding="16,10">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="{Binding StatusMessage}" Foreground="#64748b" FontSize="12"/>
                <TextBlock Grid.Column="1" Text="Powered by Avalonia" Foreground="#475569" FontSize="11"/>
            </Grid>
        </Border>
    </Grid>
</Window>
